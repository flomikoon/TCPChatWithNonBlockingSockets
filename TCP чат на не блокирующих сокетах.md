# TCP чат на не блокирующих сокетах

# Протокол

При использовании протокола подразумевается последовательность действий:

- установка соединения , выполняется сразу при подключение
- передача данных , происходит после установки соединения и до закрытия соединения
- закрытие соединения , данное действие может быть выполненно только если выполненно действие установки соединенеия , последнее действие которое может быть выполненно 

 Пакет для передачи сообщений:
 - первые 10 байт сообщения это заголовок 
   - 1 байт - определяет есть ли системное сообщение или нет ( 1 - есть , 0 - нет)
   - 2 байт - код системного сообщения
      - 1 - Сообщение о присоединившемся пользователе  
      - 2 - Пользователь с таким никнеймом уже существует
      - 3 - Клиент хочет отключиться от сервера.
   - 3 байт - размер никнейна
   - 4 байт - размер поля времени
   - 5-7 байты - размер сообщения
   - 8-10 байты - размер передаваемого файла
  - дальше идет содержание сообщения , которое содержит следующие поля
    - nickname
    - time
    - text
    - file
    
Максимальный размер text и file 16Мб , поля nickname , time , text - это строки в кодировке UTF-8

### Установка соединения

На данном этапе клиент посылает на сервер сообщение , в котором в полях nickname указано имя пользователя который хочет подключиться , в поле time указывается временная зона клиента. Со стороны сервера для каждого нового подключения создаётся сокет и сохраняется его временная зона. Если клиент с таким именем уже существует сервер посылает сообщение в коде системного сообщения указывается 2 и отключает клиента. Если с именнем все хорошо , то сервер отсылает всем подключенным клиентам сообщение в коде системного сообщения указывается 1 ,а в поле nickname указывается имя подключившегося пользователя, после чего клиент может общаться.

### Передача данных

 - Клиент - Сервер
Когда клиент посылает сообщение на сервер пакет заполняется следующим образом:
   - nickname - пустое поле
   - time - пустое поле
   - text - в данное поле запесывается текст сообщения которое хочет отправить пользователь , если отправляется файл то в данное поле записывается имя файла
   - file - в данное поле помещается файл при отправке файла , если файл не отправляется то поле пустое
 - Сервер - Клиент
При передаче сообщения от сервера к клиенту:
   - nickname - записывается имя клиента который отправил сообщение
   - time - записывается время отправки сообщения в соответсвие с временной зонной клиента
   - text - в данное поле запесывается текст сообщения которое отправил клиент , если отправляется файл то в данное поле записывается имя файла
   - file - в данное поле помещается файл который отправил клиент , если файл не отправляется то поле пустое

### Завершение соединения

Клиент отправляет сообщение в коде системного сообщения указывается 3 , после чего сервер закрывает соединение с данным клиентом.






